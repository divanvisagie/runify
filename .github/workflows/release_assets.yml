name: Build and release assets

on:
  push:
    branches: [ "builds" ]
    tags: [ "v*" ]

jobs:
  build:
    runs-on: ${{ matrix.platform }}

    strategy:
      matrix:
        platform: [macos-latest]
        arch: [x86_64, aarch64]
        include:
          - platform: macos-latest
            arch: x86_64
          - platform: macos-latest
            arch: aarch64

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ARCH: ${{ matrix.arch }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add dependencies
        run: |
          sudo apt-get update -y libmocka-dev 
          sudo apt-get install -y libc6-dev

      - name: Build the project
        run: make build TARGET=${{ env.TARGET }}

      - name: Publish the tarball release
        run: make tarball-publish TARGET=${{ env.TARGET }}
